"""
YOLO v8 å¤šæ¨¡å‹ç›®æ ‡æ£€æµ‹æ¼”ç¤ºç¨‹åº
===============================

æœ¬ç¨‹åºæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ä¸åŒçš„ YOLO v8 æ¨¡å‹å¯¹å›¾ç‰‡è¿›è¡Œç›®æ ‡æ£€æµ‹ï¼Œå¹¶ä¿å­˜æ£€æµ‹ç»“æœã€‚
æ”¯æŒ yolov8nã€yolov8sã€yolov8mã€yolov8lã€yolov8x äº”ç§æ¨¡å‹ã€‚

ä½œè€…: Claude
æ—¥æœŸ: 2025-10-23
"""

# å¯¼å…¥å¿…è¦çš„åº“
import cv2          # OpenCV - ç”¨äºå›¾åƒå¤„ç†
import os           # æ“ä½œç³»ç»Ÿæ¥å£ - ç”¨äºæ–‡ä»¶å’Œç›®å½•æ“ä½œ
import torch        # PyTorch - æ·±åº¦å­¦ä¹ æ¡†æ¶
from ultralytics import YOLO  # YOLO v8 æ¨¡å‹åº“
import glob         # ç”¨äºæ–‡ä»¶è·¯å¾„åŒ¹é…

# ===================================================================
# PyTorch 2.6 å…¼å®¹æ€§è¡¥ä¸
# ===================================================================
def patch_torch_load():
    """
    PyTorch 2.6 å®‰å…¨åŠ è½½è¡¥ä¸
    =====================

    é—®é¢˜: PyTorch 2.6 å¼•å…¥äº† weights_only=True çš„å®‰å…¨ç‰¹æ€§ï¼Œ
         ä½† YOLO æ¨¡å‹éœ€è¦ weights_only=False æ‰èƒ½æ­£å¸¸åŠ è½½ã€‚

    è§£å†³æ–¹æ¡ˆ: åˆ›å»ºä¸€ä¸ªè¡¥ä¸å‡½æ•°ï¼Œå¼ºåˆ¶æ‰€æœ‰ YOLO æ¨¡å‹åŠ è½½æ—¶
              ä½¿ç”¨ weights_only=Falseã€‚

    æ³¨æ„: è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼Œä»…ç”¨äºæ•™å­¦æ¼”ç¤ºã€‚
          åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”ä½¿ç”¨å®˜æ–¹æ¨èçš„è§£å†³æ–¹æ¡ˆã€‚
    """
    # ä¿å­˜åŸå§‹çš„ torch.load å‡½æ•°
    original_load = torch.load

    def patched_load(*args, **kwargs):
        """
        è¡¥ä¸åçš„åŠ è½½å‡½æ•°
        ================

        å‚æ•°:
            *args: ä¼ é€’ç»™åŸå§‹ torch.load çš„ä½ç½®å‚æ•°
            **kwargs: ä¼ é€’ç»™åŸå§‹ torch.load çš„å…³é”®å­—å‚æ•°

        åŠŸèƒ½:
            å¼ºåˆ¶è®¾ç½® weights_only=Falseï¼Œç¡®ä¿ YOLO æ¨¡å‹èƒ½æ­£å¸¸åŠ è½½
        """
        # æ— è®ºç”¨æˆ·å¦‚ä½•è®¾ç½®ï¼Œéƒ½å¼ºåˆ¶ä½¿ç”¨ weights_only=False
        kwargs['weights_only'] = False

        # è°ƒç”¨åŸå§‹çš„åŠ è½½å‡½æ•°
        return original_load(*args, **kwargs)

    # æ›¿æ¢åŸå§‹çš„ torch.load å‡½æ•°
    torch.load = patched_load

# åº”ç”¨è¡¥ä¸
# ========
patch_torch_load()

# ===================================================================
# ä¸»å‡½æ•°
# ===================================================================
def main():
    """
    ä¸»å‡½æ•°ï¼šYOLO v8 å¤šæ¨¡å‹æ£€æµ‹æµç¨‹
    ==============================

    æœ¬å‡½æ•°å®ç°äº†å®Œæ•´çš„å¤šæ¨¡å‹ç›®æ ‡æ£€æµ‹æµç¨‹ï¼š
    1. é…ç½®æ¨¡å‹å’Œå›¾ç‰‡åˆ—è¡¨
    2. åˆ›å»ºè¾“å‡ºç›®å½•
    3. éå†æ¨¡å‹è¿›è¡Œæ£€æµ‹
    4. ä¿å­˜æ£€æµ‹ç»“æœ
    5. è¾“å‡ºæ£€æµ‹ç»Ÿè®¡ä¿¡æ¯

    æµç¨‹å›¾:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   åˆå§‹åŒ–é…ç½®     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   åˆ›å»ºç»“æœç›®å½•   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   éå†æ¯ä¸ªæ¨¡å‹   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   åŠ è½½æ¨¡å‹      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   éå†æ¯ä¸ªå›¾ç‰‡   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   æ‰§è¡Œæ£€æµ‹      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ä¿å­˜ç»“æœ      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    # ===================================================================
    # é…ç½®éƒ¨åˆ†
    # ===================================================================
    # å®šä¹‰è¦ä½¿ç”¨çš„ YOLO v8 æ¨¡å‹åˆ—è¡¨
    # n: nano (æœ€å¿«ï¼Œç²¾åº¦æœ€ä½)
    # s: small (å¹³è¡¡é€Ÿåº¦å’Œç²¾åº¦)
    # m: medium (è¾ƒé«˜ç²¾åº¦ï¼Œé€Ÿåº¦é€‚ä¸­)
    # l: large (é«˜ç²¾åº¦ï¼Œé€Ÿåº¦è¾ƒæ…¢)
    # x: extra large (æœ€é«˜ç²¾åº¦ï¼Œé€Ÿåº¦æœ€æ…¢)
    model_names = ['yolov8n', 'yolov8s', 'yolov8m', 'yolov8l', 'yolov8x']

    # å®šä¹‰è¦æ£€æµ‹çš„å›¾ç‰‡åˆ—è¡¨
    input_images = ['pic.jpg', 'pic2.png']

    # å®šä¹‰è¾“å‡ºç›®å½•
    output_dir = 'result'

    # ===================================================================
    # åˆå§‹åŒ–é˜¶æ®µ
    # ===================================================================
    # åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    # exist_ok=True å…è®¸ç›®å½•å·²å­˜åœ¨æ—¶ä¸æŠ¥é”™
    os.makedirs(output_dir, exist_ok=True)
    print(f"è¾“å‡ºç›®å½•å·²å‡†å¤‡å°±ç»ª: {output_dir}")

    # ===================================================================
    # æ¨¡å‹æ£€æµ‹å¾ªç¯
    # ===================================================================
    # éå†æ‰€æœ‰æ¨¡å‹
    for model_name in model_names:
        print(f"\n{'='*20} ä½¿ç”¨æ¨¡å‹: {model_name.upper()} {'='*20}")

        try:
            # ------------------------------------------------------------------
            # æ¨¡å‹åŠ è½½
            # ------------------------------------------------------------------
            # YOLO(model_name) ä¼šï¼š
            # 1. æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²å­˜åœ¨æ¨¡å‹æ–‡ä»¶
            # 2. å¦‚æœä¸å­˜åœ¨ï¼Œä» Ultralytics å®˜æ–¹ä»“åº“è‡ªåŠ¨ä¸‹è½½
            # 3. åŠ è½½æ¨¡å‹åˆ°å†…å­˜
            model = YOLO(model_name)
            print(f"âœ“ æ¨¡å‹åŠ è½½æˆåŠŸ: {model_name}")

            # ------------------------------------------------------------------
            # å›¾ç‰‡æ£€æµ‹å¾ªç¯
            # ------------------------------------------------------------------
            # éå†æ‰€æœ‰è¾“å…¥å›¾ç‰‡
            for image_name in input_images:
                print(f"\n--- æ£€æµ‹å›¾ç‰‡: {image_name} ---")

                # æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                if not os.path.exists(image_name):
                    print(f"âš ï¸  è­¦å‘Š: å›¾ç‰‡ {image_name} ä¸å­˜åœ¨ï¼Œè·³è¿‡")
                    continue

                # ------------------------------------------------------------------
                # ç›®æ ‡æ£€æµ‹
                # ------------------------------------------------------------------
                # model(image_name, conf=0.25) æ‰§è¡Œæ£€æµ‹ï¼š
                # - image_name: è¾“å…¥å›¾ç‰‡è·¯å¾„
                # - conf=0.25: ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆ0-1ï¼‰ï¼Œåªæ˜¾ç¤ºç½®ä¿¡åº¦å¤§äº0.25çš„æ£€æµ‹ç»“æœ
                # - è¿”å›ç»“æœåŒ…å«æ£€æµ‹æ¡†ã€ç½®ä¿¡åº¦ã€ç±»åˆ«ç­‰ä¿¡æ¯
                print("ğŸ” æ‰§è¡Œç›®æ ‡æ£€æµ‹...")
                results = model(image_name, conf=0.25)

                # ------------------------------------------------------------------
                # ç»“æœå¯è§†åŒ–
                # ------------------------------------------------------------------
                # results[0].plot() åœ¨åŸå›¾ä¸Šç»˜åˆ¶æ£€æµ‹ç»“æœï¼š
                # - ç»˜åˆ¶è¾¹ç•Œæ¡†ï¼ˆbounding boxesï¼‰
                # - æ˜¾ç¤ºç±»åˆ«æ ‡ç­¾
                # - æ˜¾ç¤ºç½®ä¿¡åº¦åˆ†æ•°
                # - ä½¿ç”¨ä¸åŒçš„é¢œè‰²è¡¨ç¤ºä¸åŒç±»åˆ«
                print("ğŸ“Š ç”Ÿæˆæ£€æµ‹ç»“æœå¯è§†åŒ–...")
                result_img = results[0].plot()

                # ------------------------------------------------------------------
                # æ–‡ä»¶åæ„é€ 
                # ------------------------------------------------------------------
                # æ„é€ è¾“å‡ºæ–‡ä»¶åï¼Œæ ¼å¼ä¸ºï¼šå›¾ç‰‡åç§°-æ¨¡å‹åç§°.æ‰©å±•å
                # ä¾‹å¦‚: pic-yolov8n.jpg
                name_without_ext = os.path.splitext(image_name)[0]  # å»æ‰©å±•å
                ext = os.path.splitext(image_name)[1]  # è·å–æ‰©å±•å
                output_filename = f"{name_without_ext}-{model_name}{ext}"
                output_path = os.path.join(output_dir, output_filename)

                # ------------------------------------------------------------------
                # ç»“æœä¿å­˜
                # ------------------------------------------------------------------
                # cv2.imwrite å°†æ£€æµ‹ç»“æœå›¾ç‰‡ä¿å­˜åˆ°æ–‡ä»¶
                cv2.imwrite(output_path, result_img)
                print(f"âœ“ ç»“æœå·²ä¿å­˜: {output_path}")

                # ------------------------------------------------------------------
                # æ£€æµ‹ç»“æœç»Ÿè®¡
                # ------------------------------------------------------------------
                # results[0].boxes åŒ…å«æ‰€æœ‰æ£€æµ‹åˆ°çš„è¾¹ç•Œæ¡†ä¿¡æ¯
                boxes = results[0].boxes

                if boxes is not None and len(boxes) > 0:
                    print(f"ğŸ¯ æ£€æµ‹åˆ° {len(boxes)} ä¸ªç‰©ä½“")

                    # ç»Ÿè®¡å„ç±»åˆ«çš„æ£€æµ‹æ•°é‡
                    class_counts = {}
                    for box in boxes:
                        cls_id = int(box.cls)  # è·å–ç±»åˆ«ID
                        cls_name = model.names[cls_id]  # é€šè¿‡IDè·å–ç±»åˆ«åç§°
                        class_counts[cls_name] = class_counts.get(cls_name, 0) + 1

                    # æ‰“å°å„ç±»åˆ«çš„ç»Ÿè®¡ç»“æœ
                    print("ğŸ“‹ ç‰©ä½“ç±»åˆ«ç»Ÿè®¡:")
                    for cls_name, count in class_counts.items():
                        print(f"   â€¢ {cls_name}: {count}ä¸ª")

                    # æ‰“å°æ¯ä¸ªæ£€æµ‹å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯
                    print("ğŸ” æ£€æµ‹è¯¦æƒ…:")
                    for i, box in enumerate(boxes):
                        cls_id = int(box.cls)
                        cls_name = model.names[cls_id]
                        confidence = float(box.conf)  # ç½®ä¿¡åº¦
                        print(f"   {i+1}. {cls_name} (ç½®ä¿¡åº¦: {confidence:.2f})")
                else:
                    print("âŒ æœªæ£€æµ‹åˆ°ç‰©ä½“")

        except Exception as e:
            print(f"âŒ ä½¿ç”¨æ¨¡å‹ {model_name} æ—¶å‡ºé”™: {str(e)}")
            print("ç»§ç»­ä½¿ç”¨ä¸‹ä¸€ä¸ªæ¨¡å‹...")
            continue

    # ===================================================================
    # ç¨‹åºç»“æŸ
    # ===================================================================
    print(f"\n{'='*60}")
    print("ğŸ‰ æ‰€æœ‰æ£€æµ‹ä»»åŠ¡å®Œæˆï¼")
    print(f"ğŸ“ æ‰€æœ‰ç»“æœå·²ä¿å­˜åˆ°: {output_dir} ç›®å½•")

    # åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
    output_files = glob.glob(os.path.join(output_dir, "*"))
    if output_files:
        print("\nğŸ“„ ç”Ÿæˆçš„æ£€æµ‹æ–‡ä»¶:")
        for file in output_files:
            print(f"   âœ“ {os.path.basename(file)}")

    print("\nğŸ’¡ æç¤º:")
    print("   â€¢ æ¨¡å‹å¤§å°: n < s < m < l < x")
    print("   â€¢ æ£€æµ‹ç²¾åº¦: n < s < m < l < x")
    print("   â€¢ è¿è¡Œé€Ÿåº¦: n > s > m > l > x")
    print("=" * 60)


# ===================================================================
# ç¨‹åºå…¥å£ç‚¹
# ===================================================================
if __name__ == "__main__":
    """
    ç¨‹åºå…¥å£ç‚¹
    =========

    è¿™ä¸ªæ¡ä»¶åˆ¤æ–­ç¡®ä¿ä»£ç åªåœ¨ç›´æ¥è¿è¡Œè„šæœ¬æ—¶æ‰§è¡Œï¼Œ
    è€Œåœ¨ä½œä¸ºæ¨¡å—å¯¼å…¥æ—¶ä¸æ‰§è¡Œã€‚

    è¿™æ˜¯Pythonçš„æ ‡å‡†ç¼–ç¨‹å®è·µï¼Œä¾¿äºä»£ç å¤ç”¨ã€‚
    """
    print("ğŸš€ å¯åŠ¨ YOLO v8 å¤šæ¨¡å‹ç›®æ ‡æ£€æµ‹ç¨‹åº")
    print("=" * 60)

    # è°ƒç”¨ä¸»å‡½æ•°
    main()