<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSE ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-controls {
            margin: 15px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: black;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .video-container {
            margin: 20px 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        video {
            width: 100%;
            max-width: 400px;
            height: 225px;
            background: #000;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        .log {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            border-radius: 5px;
            font-size: 12px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ MSE ä¿®å¤éªŒè¯æµ‹è¯•</h1>
        <p>æµ‹è¯• MediaSource Extensions ç”Ÿå‘½å‘¨æœŸä¿®å¤æ•ˆæœ</p>

        <div class="test-controls">
            <button class="btn-primary" onclick="runAllTests()">ğŸ§ª è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
            <button class="btn-success" onclick="testMSESupport()">âœ… æµè§ˆå™¨æ”¯æŒ</button>
            <button class="btn-warning" onclick="testMSELoading()">ğŸ“¹ MSE åŠ è½½æµ‹è¯•</button>
            <button class="btn-danger" onclick="testMSELifecycle()">â™»ï¸ ç”Ÿå‘½å‘¨æœŸæµ‹è¯•</button>
            <button class="btn-primary" onclick="clearLogs()">ğŸ§¹ æ¸…ç†æ—¥å¿—</button>
        </div>

        <div id="testResults" class="test-results"></div>

        <div class="video-container">
            <div>
                <h3>æ‘„åƒå¤´ 1 - MSE æµ‹è¯•</h3>
                <video id="video1" controls muted playsinline></video>
                <div class="test-controls">
                    <button class="btn-success" onclick="loadMSEVideo('camera1', 'video1')">åŠ è½½ MSE</button>
                    <button class="btn-danger" onclick="stopVideo('video1')">åœæ­¢</button>
                </div>
            </div>
            <div>
                <h3>æ‘„åƒå¤´ 2 - MSE æµ‹è¯•</h3>
                <video id="video2" controls muted playsinline></video>
                <div class="test-controls">
                    <button class="btn-success" onclick="loadMSEVideo('camera2', 'video2')">åŠ è½½ MSE</button>
                    <button class="btn-danger" onclick="stopVideo('video2')">åœæ­¢</button>
                </div>
            </div>
        </div>

        <div class="log" id="logPanel"></div>
    </div>

    <script>
        const config = {
            server: 'http://localhost:8081',
            mseInstances: {},
            testResults: []
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logPanel = document.getElementById('logPanel');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(message);
        }

        function addTestResult(testName, passed, message) {
            const result = {
                test: testName,
                passed: passed,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            };
            config.testResults.push(result);

            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            resultDiv.innerHTML = `
                <strong>${testName}</strong> - ${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                <span style="float: right;">${result.timestamp}</span><br>
                <small>${message}</small>
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function testMSESupport() {
            log('å¼€å§‹æµ‹è¯• MSE æµè§ˆå™¨æ”¯æŒ...', 'info');

            let passed = true;
            let message = '';

            if (!window.MediaSource) {
                passed = false;
                message = 'MediaSource API ä¸å¯ç”¨';
                log('âŒ MediaSource API ä¸å¯ç”¨', 'error');
            } else {
                message += 'MediaSource API å¯ç”¨. ';
                log('âœ… MediaSource API å¯ç”¨', 'success');

                const codec = 'video/mp4; codecs="avc1.42E01E,mp4a.40.2"';
                if (!MediaSource.isTypeSupported(codec)) {
                    passed = false;
                    message += 'MP4 ç¼–è§£ç å™¨ä¸æ”¯æŒ';
                    log('âŒ MP4 ç¼–è§£ç å™¨ä¸æ”¯æŒ', 'error');
                } else {
                    message += 'MP4 ç¼–è§£ç å™¨æ”¯æŒ';
                    log('âœ… MP4 ç¼–è§£ç å™¨æ”¯æŒ', 'success');
                }
            }

            addTestResult('æµè§ˆå™¨ MSE æ”¯æŒ', passed, message);
            return passed;
        }

        function testMSELoading() {
            log('å¼€å§‹æµ‹è¯• MSE è§†é¢‘åŠ è½½...', 'info');

            if (!testMSESupport()) {
                addTestResult('MSE åŠ è½½æµ‹è¯•', false, 'æµè§ˆå™¨ä¸æ”¯æŒ MSE');
                return false;
            }

            return new Promise((resolve) => {
                const video = document.getElementById('video1');
                const mp4Url = `${config.server}/api/stream.mp4?src=camera1`;

                // æ¸…ç†ç°æœ‰å®ä¾‹
                if (config.mseInstances.camera1) {
                    cleanupMSE('camera1');
                }

                const mediaSource = new MediaSource();
                video.src = URL.createObjectURL(mediaSource);

                config.mseInstances.camera1 = {
                    mediaSource: mediaSource,
                    sourceBuffer: null,
                    streamController: null,
                    isActive: true,
                    queue: []
                };

                let testPassed = false;
                let testMessage = '';

                mediaSource.addEventListener('sourceopen', () => {
                    if (!config.mseInstances.camera1 || !config.mseInstances.camera1.isActive) {
                        testMessage = 'MSE å®ä¾‹å·²è¢«æ¸…ç†';
                        log('MSE å®ä¾‹å·²è¢«æ¸…ç†ï¼Œå–æ¶ˆåˆå§‹åŒ–', 'warning');
                        addTestResult('MSE åŠ è½½æµ‹è¯•', false, testMessage);
                        resolve(false);
                        return;
                    }

                    log('MSE åª’ä½“æºå·²æ‰“å¼€', 'success');

                    try {
                        const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E,mp4a.40.2"');
                        config.mseInstances.camera1.sourceBuffer = sourceBuffer;

                        sourceBuffer.addEventListener('updateend', () => {
                            if (!config.mseInstances.camera1 || !config.mseInstances.camera1.isActive) {
                                return;
                            }

                            const instance = config.mseInstances.camera1;
                            if (instance.queue && instance.queue.length > 0 && !sourceBuffer.updating) {
                                try {
                                    const buffer = instance.queue.shift();
                                    sourceBuffer.appendBuffer(buffer);
                                } catch (e) {
                                    log(`é˜Ÿåˆ—å¤„ç†é”™è¯¯: ${e.message}`, 'warning');
                                }
                            }
                        });

                        sourceBuffer.addEventListener('error', (e) => {
                            log(`SourceBuffer é”™è¯¯: ${e.message}`, 'error');
                            testMessage = `SourceBuffer é”™è¯¯: ${e.message}`;
                        });

                        config.mseInstances.camera1.streamController = new AbortController();
                        fetchMSEStream(mp4Url, sourceBuffer, config.mseInstances.camera1.queue, 'camera1');

                    } catch (e) {
                        testMessage = `åˆ›å»º SourceBuffer å¤±è´¥: ${e.message}`;
                        log(testMessage, 'error');
                        addTestResult('MSE åŠ è½½æµ‹è¯•', false, testMessage);
                        resolve(false);
                    }
                });

                video.addEventListener('loadeddata', () => {
                    testPassed = true;
                    testMessage = 'MSE è§†é¢‘åŠ è½½æˆåŠŸ';
                    log(testMessage, 'success');
                    video.play().catch(e => {
                        log(`è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ${e.message}`, 'warning');
                    });
                    addTestResult('MSE åŠ è½½æµ‹è¯•', true, testMessage);
                    resolve(true);
                });

                video.addEventListener('error', (e) => {
                    testMessage = `MSE è§†é¢‘åŠ è½½å¤±è´¥: ${e.message}`;
                    log(testMessage, 'error');
                    addTestResult('MSE åŠ è½½æµ‹è¯•', false, testMessage);
                    resolve(false);
                });

                // 30ç§’è¶…æ—¶
                setTimeout(() => {
                    if (!testPassed) {
                        testMessage = 'MSE åŠ è½½è¶…æ—¶';
                        log(testMessage, 'warning');
                        addTestResult('MSE åŠ è½½æµ‹è¯•', false, testMessage);
                        resolve(false);
                    }
                }, 30000);
            });
        }

        async function testMSELifecycle() {
            log('å¼€å§‹æµ‹è¯• MSE ç”Ÿå‘½å‘¨æœŸç®¡ç†...', 'info');

            let passed = true;
            let message = '';

            // æµ‹è¯•å¤šæ¬¡åŠ è½½å’Œæ¸…ç†
            for (let i = 0; i < 3; i++) {
                log(`ç”Ÿå‘½å‘¨æœŸæµ‹è¯•è½®æ¬¡ ${i + 1}/3`, 'info');

                try {
                    // åŠ è½½ MSE
                    await loadMSEVideo('camera2', 'video2');
                    await new Promise(resolve => setTimeout(resolve, 3000));

                    // æ¸…ç† MSE
                    cleanupMSE('camera2');
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    message += `è½®æ¬¡ ${i + 1} å®Œæˆ. `;
                } catch (e) {
                    passed = false;
                    message += `è½®æ¬¡ ${i + 1} å¤±è´¥: ${e.message}. `;
                    log(`ç”Ÿå‘½å‘¨æœŸæµ‹è¯•è½®æ¬¡ ${i + 1} å¤±è´¥: ${e.message}`, 'error');
                }
            }

            addTestResult('MSE ç”Ÿå‘½å‘¨æœŸæµ‹è¯•', passed, message);
            return passed;
        }

        async function runAllTests() {
            log('å¼€å§‹è¿è¡Œå…¨éƒ¨æµ‹è¯•...', 'info');

            // æ¸…ç†ä¹‹å‰çš„ç»“æœ
            document.getElementById('testResults').innerHTML = '';
            config.testResults = [];

            // è¿è¡Œæ‰€æœ‰æµ‹è¯•
            await testMSESupport();
            await testMSELoading();
            await testMSELifecycle();

            // æ€»ç»“ç»“æœ
            const passedTests = config.testResults.filter(r => r.passed).length;
            const totalTests = config.testResults.length;

            log(`æµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} æµ‹è¯•é€šè¿‡`, passedTests === totalTests ? 'success' : 'warning');
        }

        function loadMSEVideo(camera, videoId) {
            return new Promise((resolve, reject) => {
                const video = document.getElementById(videoId);
                const mp4Url = `${config.server}/api/stream.mp4?src=${camera}`;

                log(`å¼€å§‹åŠ è½½ ${camera} MSE è§†é¢‘...`, 'info');

                if (!window.MediaSource || !MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')) {
                    const error = 'æµè§ˆå™¨ä¸æ”¯æŒ MSE';
                    log(`${camera}: ${error}`, 'error');
                    reject(new Error(error));
                    return;
                }

                // æ¸…ç†ç°æœ‰å®ä¾‹
                if (config.mseInstances[camera]) {
                    cleanupMSE(camera);
                }

                const mediaSource = new MediaSource();
                video.src = URL.createObjectURL(mediaSource);

                // å­˜å‚¨å®Œæ•´çš„ MSE å®ä¾‹ä¿¡æ¯
                config.mseInstances[camera] = {
                    mediaSource: mediaSource,
                    sourceBuffer: null,
                    streamController: null,
                    isActive: true,
                    queue: []
                };

                mediaSource.addEventListener('sourceopen', () => {
                    if (!config.mseInstances[camera] || !config.mseInstances[camera].isActive) {
                        const error = 'MSE å®ä¾‹å·²è¢«æ¸…ç†ï¼Œå–æ¶ˆåˆå§‹åŒ–';
                        log(`${camera}: ${error}`, 'warning');
                        reject(new Error(error));
                        return;
                    }

                    log(`${camera}: MSE åª’ä½“æºå·²æ‰“å¼€`, 'success');

                    try {
                        const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E,mp4a.40.2"');
                        config.mseInstances[camera].sourceBuffer = sourceBuffer;

                        sourceBuffer.addEventListener('updateend', () => {
                            if (!config.mseInstances[camera] || !config.mseInstances[camera].isActive) {
                                return;
                            }

                            const instance = config.mseInstances[camera];
                            if (instance.queue && instance.queue.length > 0 && !sourceBuffer.updating) {
                                try {
                                    const buffer = instance.queue.shift();
                                    sourceBuffer.appendBuffer(buffer);
                                } catch (e) {
                                    log(`${camera}: é˜Ÿåˆ—å¤„ç†é”™è¯¯: ${e.message}`, 'warning');
                                }
                            }
                        });

                        sourceBuffer.addEventListener('error', (e) => {
                            const error = `SourceBuffer é”™è¯¯: ${e.message}`;
                            log(`${camera}: ${error}`, 'error');
                            reject(new Error(error));
                        });

                        config.mseInstances[camera].streamController = new AbortController();
                        fetchMSEStream(mp4Url, sourceBuffer, config.mseInstances[camera].queue, camera);

                    } catch (e) {
                        const error = `åˆ›å»º SourceBuffer å¤±è´¥: ${e.message}`;
                        log(`${camera}: ${error}`, 'error');
                        cleanupMSE(camera);
                        reject(new Error(error));
                    }
                });

                video.addEventListener('loadeddata', () => {
                    log(`${camera}: MSE è§†é¢‘åŠ è½½æˆåŠŸ`, 'success');
                    video.play().catch(e => {
                        log(`${camera}: è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ${e.message}`, 'warning');
                    });
                    resolve();
                });

                video.addEventListener('error', (e) => {
                    const error = `MSE åŠ è½½å¤±è´¥: ${e.message}`;
                    log(`${camera}: ${error}`, 'error');
                    cleanupMSE(camera);
                    reject(new Error(error));
                });
            });
        }

        async function fetchMSEStream(url, sourceBuffer, queue, camera) {
            const instance = config.mseInstances[camera];
            if (!instance || !instance.isActive || !instance.streamController) {
                log(`${camera}: MSE å®ä¾‹ä¸å¯ç”¨ï¼Œå–æ¶ˆæµè·å–`, 'warning');
                return;
            }

            try {
                const response = await fetch(url, { signal: instance.streamController.signal });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const reader = response.body.getReader();
                let bufferCount = 0;

                while (true) {
                    if (!instance.isActive || instance.streamController.signal.aborted) {
                        log(`${camera}: MSE æµè·å–è¢«ä¸­æ–­`, 'info');
                        break;
                    }

                    const { done, value } = await reader.read();
                    if (done) break;

                    if (value && value.length > 0) {
                        bufferCount++;

                        if (!instance.isActive) break;

                        if (!sourceBuffer.updating) {
                            try {
                                sourceBuffer.appendBuffer(value);

                                if (bufferCount % 50 === 0) {
                                    log(`${camera}: å·²å¤„ç† ${bufferCount} ä¸ªæ•°æ®å—`, 'info');
                                }
                            } catch (e) {
                                log(`${camera}: ç¼“å†²åŒºé”™è¯¯: ${e.message}`, 'warning');
                                if (instance.isActive) {
                                    if (queue.length < 100) {
                                        queue.push(value);
                                    } else {
                                        log(`${camera}: é˜Ÿåˆ—å·²æ»¡ï¼Œä¸¢å¼ƒæ•°æ®å—`, 'warning');
                                    }
                                }
                            }
                        } else {
                            if (queue.length < 100) {
                                queue.push(value);
                            } else {
                                log(`${camera}: é˜Ÿåˆ—å·²æ»¡ï¼Œä¸¢å¼ƒæ•°æ®å—`, 'warning');
                            }
                        }
                    }
                }

                if (instance.isActive) {
                    log(`${camera}: MSE æµè·å–å®Œæˆï¼Œå…±å¤„ç† ${bufferCount} ä¸ªæ•°æ®å—`, 'success');
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    log(`${camera}: MSE æµè·å–è¢«ä¸»åŠ¨ä¸­æ­¢`, 'info');
                } else {
                    log(`${camera}: MSE æµè·å–å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        function cleanupMSE(camera) {
            const instance = config.mseInstances[camera];
            if (!instance) return;

            log(`${camera}: æ¸…ç† MSE å®ä¾‹`, 'info');

            try {
                // ä¸­æ­¢æµè·å–
                if (instance.streamController) {
                    instance.streamController.abort();
                    instance.streamController = null;
                }

                // æ ‡è®°ä¸ºéæ´»è·ƒçŠ¶æ€
                instance.isActive = false;

                // æ¸…ç†é˜Ÿåˆ—
                if (instance.queue) {
                    instance.queue = [];
                }

                // æ¸…ç† SourceBuffer
                if (instance.sourceBuffer) {
                    if (instance.mediaSource.readyState === 'open') {
                        try {
                            if (instance.sourceBuffer.updating) {
                                instance.sourceBuffer.abort();
                            }
                            instance.mediaSource.removeSourceBuffer(instance.sourceBuffer);
                        } catch (e) {
                            log(`${camera}: ç§»é™¤ SourceBuffer é”™è¯¯: ${e.message}`, 'warning');
                        }
                    }
                    instance.sourceBuffer = null;
                }

                // ç»“æŸåª’ä½“æº
                if (instance.mediaSource && instance.mediaSource.readyState === 'open') {
                    try {
                        instance.mediaSource.endOfStream();
                    } catch (e) {
                        log(`${camera}: ç»“æŸ MediaStream é”™è¯¯: ${e.message}`, 'warning');
                    }
                }

            } catch (e) {
                log(`${camera}: æ¸…ç† MSE å®ä¾‹é”™è¯¯: ${e.message}`, 'warning');
            } finally {
                // åˆ é™¤å®ä¾‹å¼•ç”¨
                config.mseInstances[camera] = null;
                delete config.mseInstances[camera];
            }
        }

        function stopVideo(videoId) {
            const video = document.getElementById(videoId);

            // æ ¹æ®è§†é¢‘IDæ¨æ–­æ‘„åƒå¤´åç§°
            const camera = videoId.replace('video', 'camera');

            // æ¸…ç† MSE å®ä¾‹
            if (config.mseInstances[camera]) {
                cleanupMSE(camera);
            }

            // æ¸…ç†è§†é¢‘å…ƒç´ 
            video.src = '';
            video.load();

            log(`${camera}: è§†é¢‘å·²åœæ­¢`, 'info');
        }

        function clearLogs() {
            document.getElementById('logPanel').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç†', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•æµè§ˆå™¨æ”¯æŒ
        window.addEventListener('load', () => {
            log('MSE ä¿®å¤éªŒè¯æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            setTimeout(testMSESupport, 1000);
        });
    </script>
</body>
</html>